<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç”Ÿæ´»å…¨èƒ½åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* è¿™é‡Œä¿ç•™ä½ åŸæ¥çš„ CSS æ ·å¼ï¼Œæˆ‘ä¸ºä½ ç²¾ç®€äº†æ ¸å¿ƒå±•ç¤ºéƒ¨åˆ† */
        :root { --primary: #4f46e5; --bg: #f9fafb; }
        body { background: var(--bg); font-family: 'PingFang SC', sans-serif; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .price { color: #ff4d4f; font-size: 1.2rem; font-weight: bold; }
        .img-container { display: flex; gap: 10px; overflow-x: auto; margin: 10px 0; }
        .img-container img { height: 120px; border-radius: 8px; border: 1px solid #eee; }
        .input-group { margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <header style="text-align:center; margin-bottom:20px;">
        <h2>ğŸ« æ ¡å›­ç”Ÿæ´»åŠ©æ‰‹</h2>
        <p id="status" style="color: #666; font-size: 0.9rem;">æ­£åœ¨è¿æ¥äº‘ç«¯...</p>
    </header>

    <div class="card">
        <h3>å‘å¸ƒé—²ç½® / éœ€æ±‚</h3>
        <div class="input-group"><input type="text" id="m_name" placeholder="å•†å“æˆ–æ ‡é¢˜åç§°"></div>
        <div class="input-group"><input type="number" id="m_price" placeholder="é‡‘é¢ (Â¥)"></div>
        <div class="input-group"><input type="text" id="m_contact" placeholder="è”ç³»æ–¹å¼ (å¾®ä¿¡/QQ)"></div>
        <div class="input-group"><input type="file" id="m_files" multiple accept="image/*"></div>
        <button class="btn" onclick="publish()">ç¡®è®¤å‘å¸ƒåˆ°äº‘æ•°æ®åº“</button>
    </div>

    <div id="list-container"></div>

    <script>
        // --- 1. åˆå§‹åŒ–ä½ çš„ Supabase (å·²å¡«å…¥ä½ æˆªå›¾ä¸­çš„ Key) ---
        const SUPABASE_URL = 'https://xhcqqnpzyafvjsxyndya.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gsBzkYayDH3Z3jbEENOLrA__a7tf2TA';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // æ£€æŸ¥è¿æ¥
        window.onload = () => {
            document.getElementById('status').innerText = "âœ… äº‘ç«¯å·²è¿æ¥ (Supabase)";
            fetchData();
        };

        // --- 2. å‘å¸ƒé€»è¾‘ (æ›¿æ¢æ‰åŸæ¥çš„ AV.Object) ---
        async function publish() {
            const name = document.getElementById('m_name').value;
            const price = document.getElementById('m_price').value;
            const contact = document.getElementById('m_contact').value;
            const fileInput = document.getElementById('m_files');

            if (!name || fileInput.files.length === 0) {
                return alert("è¯·è‡³å°‘å¡«å†™åç§°å¹¶ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼");
            }

            const btn = document.querySelector('.btn');
            btn.innerText = "æ­£åœ¨åŒæ­¥äº‘ç«¯...";
            btn.disabled = true;

            try {
                // ä¸Šä¼ å›¾ç‰‡åˆ° IMAGES å­˜å‚¨æ¡¶
                const imageUrls = [];
                for (let file of fileInput.files) {
                    const fileName = `${Date.now()}_${file.name}`;
                    const { data, error } = await _supabase.storage
                        .from('IMAGES') // æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»å’Œ Supabase åå°æ¡¶åä¸€è‡´
                        .upload(fileName, file);
                    
                    if (error) throw error;

                    const { data: { publicUrl } } = _supabase.storage.from('IMAGES').getPublicUrl(fileName);
                    imageUrls.push(publicUrl);
                }

                // å†™å…¥æ•°æ®åº“è¡¨ Market
                const { error: dbError } = await _supabase
                    .from('Market')
                    .insert([{ name, price: parseFloat(price), contact, images: imageUrls }]);

                if (dbError) throw dbError;

                alert("å‘å¸ƒæˆåŠŸï¼");
                location.reload();
            } catch (err) {
                console.error(err);
                alert("å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š\n1. Storage æ˜¯å¦å¼€äº† Policy æƒé™\n2. æ¡¶åæ˜¯å¦å« IMAGES\né”™è¯¯è¯¦æƒ…ï¼š" + err.message);
            } finally {
                btn.innerText = "ç¡®è®¤å‘å¸ƒåˆ°äº‘æ•°æ®åº“";
                btn.disabled = false;
            }
        }

        // --- 3. è·å–æ•°æ®é€»è¾‘ ---
        async function fetchData() {
            const { data, error } = await _supabase
                .from('Market')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) return console.error("åŠ è½½å¤±è´¥:", error);

            const container = document.getElementById('list-container');
            container.innerHTML = data.map(item => `
                <div class="card">
                    <div class="price">Â¥${item.price || 0}</div>
                    <h4 style="margin: 5px 0;">${item.name}</h4>
                    <div class="img-container">
                        ${(item.images || []).map(url => `<img src="${url}">`).join('')}
                    </div>
                    <div style="font-size: 0.85rem; color: #666;">ğŸ“ è”ç³»: ${item.contact}</div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
