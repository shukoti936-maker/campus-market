<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç”Ÿæ´»åŠ©æ‰‹ - å¢å¼ºæµè§ˆç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --bg: #f3f4f6; --text: #1f2937; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }
        
        header { background: #fff; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        nav { display: flex; gap: 10px; }
        .nav-link { padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; font-size: 0.9rem; }
        .nav-link.active { background: var(--primary); color: white; }
        
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* åˆ—è¡¨å¡ç‰‡æ ·å¼ */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-3px); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card-body { padding: 12px; }
        .price { color: #ef4444; font-size: 1.1rem; font-weight: 800; }
        .badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }

        /* æ¨¡æ€æ¡†é€šç”¨æ ·å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 16px; max-height: 85vh; overflow-y: auto; position: relative; }
        
        /* è¯¦æƒ…é¡µä¸“ç”¨æ ·å¼ */
        .detail-gallery { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 15px; scroll-snap-type: x mandatory; }
        .detail-gallery img { width: 80%; flex-shrink: 0; border-radius: 8px; scroll-snap-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .detail-info h2 { margin-bottom: 10px; color: var(--primary); }
        .detail-item { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .detail-label { color: #888; font-size: 0.8rem; }
        .qr-section { background: #f0fdf4; padding: 10px; border-radius: 8px; text-align: center; margin-top: 15px; }
        .qr-img { width: 150px; height: 150px; margin-top: 5px; border: 2px solid var(--secondary); }

        /* å‘å¸ƒé¡µå›¾ç‰‡é¢„è§ˆ */
        .preview-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .preview-item { position: relative; width: 60px; height: 60px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .remove-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 12px; text-align: center; line-height: 18px; cursor: pointer; }

        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #999; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.reload()">ğŸ« æ ¡å›­åŠ©æ‰‹</div>
        <nav>
            <div class="nav-link active" id="nav-market" onclick="switchSection('market')">äºŒæ‰‹</div>
            <div class="nav-link" id="nav-carpool" onclick="switchSection('carpool')">æ‹¼è½¦</div>
            <div class="nav-link" id="nav-jobs" onclick="switchSection('jobs')">å…¼èŒ</div>
        </nav>
        <button id="loginBtn" onclick="doLogin()" style="font-size: 0.8rem; border: none; background: #eee; padding: 5px 10px; border-radius: 15px;">ç”¨æˆ·è¿æ¥</button>
    </header>

    <main>
        <section id="marketSection" class="content-section active">
            <div class="section-header"><h3>äºŒæ‰‹é›†å¸‚</h3><button class="btn-main" onclick="openModal('pubMarket')">+ å‘å¸ƒ</button></div>
            <div class="data-grid" id="marketList"></div>
        </section>

        <section id="carpoolSection" class="content-section">
            <div class="section-header"><h3>æ‹¼è½¦è®¡åˆ’</h3><button class="btn-main" onclick="openModal('pubCarpool')">+ å‘å¸ƒ</button></div>
            <div class="data-grid" id="carpoolList"></div>
        </section>

        <section id="jobsSection" class="content-section">
            <div class="section-header"><h3>å…¼èŒæ‹›è˜</h3><button class="btn-main" onclick="openModal('pubJob')">+ å‘å¸ƒ</button></div>
            <div class="data-grid" id="jobsList"></div>
        </section>
    </main>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">Ã—</span>
            <div id="detailContent">
                </div>
        </div>
    </div>

    <div id="pubMarket" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒäºŒæ‰‹å•†å“</h3>
            <input type="text" id="m_t" placeholder="å•†å“åç§°" style="margin-top:10px">
            <input type="number" id="m_p" placeholder="ä»·æ ¼ (Â¥)" style="margin:10px 0">
            <input type="text" id="m_c" placeholder="å¾®ä¿¡å·/æ‰‹æœºå·">
            <div style="margin-top:10px"><label>å®ç‰©å›¾ï¼š</label><input type="file" multiple onchange="handleImgs(this, 'pre_m', 'store_m')"></div>
            <div class="preview-grid" id="pre_m"></div>
            <div style="margin-top:10px"><label>æ”¶æ¬¾ç (å¯é€‰)ï¼š</label><input type="file" onchange="handleImgs(this, 'pre_q', 'store_q')"></div>
            <div class="preview-grid" id="pre_q"></div>
            <button class="btn-main" style="width:100%; margin-top:15px" onclick="submit('Market')">ç¡®è®¤åŒæ­¥äº‘ç«¯</button>
        </div>
    </div>

    <div id="pubCarpool" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒæ‹¼è½¦è¡Œç¨‹</h3>
            <input type="text" id="c_t" placeholder="è·¯çº¿ï¼šä¾‹å¦‚ å®¿èˆ-é«˜é“ç«™" style="margin-top:10px">
            <input type="text" id="c_time" placeholder="å‡ºå‘æ—¶é—´" style="margin:10px 0">
            <input type="text" id="c_c" placeholder="è”ç³»æ–¹å¼">
            <div style="margin-top:10px"><label>è¡Œç¨‹å›¾ï¼š</label><input type="file" multiple onchange="handleImgs(this, 'pre_c', 'store_c')"></div>
            <div class="preview-grid" id="pre_c"></div>
            <button class="btn-main" style="width:100%; margin-top:15px" onclick="submit('Carpool')">ç¡®è®¤åŒæ­¥äº‘ç«¯</button>
        </div>
    </div>

    <div id="pubJob" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒå…¼èŒå²—ä½</h3>
            <input type="text" id="j_t" placeholder="å²—ä½åç§°" style="margin-top:10px">
            <input type="text" id="j_p" placeholder="è–ªèµ„è¯¦æƒ…" style="margin:10px 0">
            <textarea id="j_d" placeholder="è¦æ±‚ä¸èŒè´£" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;"></textarea>
            <input type="text" id="j_c" placeholder="è”ç³»æ–¹å¼" style="margin-top:10px">
            <div style="margin-top:10px"><label>æµ·æŠ¥å›¾ï¼š</label><input type="file" multiple onchange="handleImgs(this, 'pre_j', 'store_j')"></div>
            <div class="preview-grid" id="pre_j"></div>
            <button class="btn-main" style="width:100%; margin-top:15px" onclick="submit('Job')">ç¡®è®¤åŒæ­¥äº‘ç«¯</button>
        </div>
    </div>

    <script>
        // --- åˆå§‹åŒ– ---
        const SUPABASE_URL = 'https://xhcqqnpzyafvjsxyndya.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gsBzkYayDH3Z3jbEENOLrA__a7tf2TA';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLogin = false;
        let files = { store_m: [], store_q: [], store_c: [], store_j: [] };

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæµè§ˆè¯¦æƒ… ---
        function showDetail(item, type) {
            const content = document.getElementById('detailContent');
            let imagesHtml = (item.images || []).map(src => `<img src="${src}" onclick="window.open('${src}')">`).join('');
            
            let html = `
                <div class="detail-gallery">${imagesHtml}</div>
                <div class="detail-info">
                    <h2>${item.name || item.route || item.title}</h2>
                    ${item.price ? `<div class="detail-item"><span class="detail-label">ä»·æ ¼ï¼š</span><span class="price">Â¥${item.price}</span></div>` : ''}
                    ${item.time ? `<div class="detail-item"><span class="detail-label">å‡ºå‘æ—¶é—´ï¼š</span><span>${item.time}</span></div>` : ''}
                    ${item.pay ? `<div class="detail-item"><span class="detail-label">è–ªèµ„ï¼š</span><span style="color:green;font-weight:bold">${item.pay}</span></div>` : ''}
                    <div class="detail-item"><span class="detail-label">å‘å¸ƒæ—¶é—´ï¼š</span><span>${new Date(item.created_at).toLocaleString()}</span></div>
                    <div class="detail-item" style="background:#f9f9f9; padding:10px; border-radius:8px;">
                        <span class="detail-label">è”ç³»æ–¹å¼ï¼š</span><br>
                        <strong style="font-size:1.1rem">${item.contact}</strong>
                    </div>
                    ${item.qr ? `
                        <div class="qr-section">
                            <span class="detail-label">æ‰«ç æ”¯ä»˜/åŠ å¥½å‹ï¼š</span><br>
                            <img src="${item.qr}" class="qr-img">
                        </div>
                    ` : ''}
                </div>
                <p style="text-align:center; color:#ccc; font-size:12px; margin-top:15px;">ç‚¹å‡»å¤§å›¾å¯æŸ¥çœ‹åŸå›¾</p>
            `;
            content.innerHTML = html;
            openModal('detailModal');
        }

        // --- å›¾ç‰‡å¤„ç† ---
        function handleImgs(input, preId, key) {
            const selected = Array.from(input.files);
            selected.forEach(file => {
                files[key].push(file);
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `<img src="${e.target.result}"><div class="remove-btn" onclick="this.parentElement.remove()">Ã—</div>`;
                    document.getElementById(preId).appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // --- æäº¤æ•°æ® ---
        async function submit(type) {
            if(!isLogin) return alert("è¯·å…ˆç‚¹å‡»'ç”¨æˆ·è¿æ¥'æŒ‰é’®");
            const btn = event.target;
            btn.innerText = "åŒæ­¥ä¸­..."; btn.disabled = true;

            try {
                let key = type === 'Market' ? 'store_m' : (type === 'Carpool' ? 'store_c' : 'store_j');
                const imgUrls = [];
                for(let f of files[key]) {
                    const name = `${Date.now()}_${f.name}`;
                    await _supabase.storage.from('images').upload(name, f);
                    imgUrls.push(_supabase.storage.from('images').getPublicUrl(name).data.publicUrl);
                }

                let qrUrl = "";
                if(type === 'Market' && files.store_q.length > 0) {
                    const name = `QR_${Date.now()}.png`;
                    await _supabase.storage.from('images').upload(name, files.store_q[0]);
                    qrUrl = _supabase.storage.from('images').getPublicUrl(name).data.publicUrl;
                }

                let data = { images: imgUrls };
                if(type === 'Market') {
                    data.name = document.getElementById('m_t').value;
                    data.price = document.getElementById('m_p').value;
                    data.contact = document.getElementById('m_c').value;
                    data.qr = qrUrl;
                } else if(type === 'Carpool') {
                    data.route = document.getElementById('c_t').value;
                    data.time = document.getElementById('c_time').value;
                    data.contact = document.getElementById('c_c').value;
                } else if(type === 'Job') {
                    data.title = document.getElementById('j_t').value;
                    data.pay = document.getElementById('j_p').value;
                    data.contact = document.getElementById('j_c').value;
                }

                await _supabase.from(type).insert([data]);
                alert("äº‘ç«¯åŒæ­¥æˆåŠŸï¼");
                location.reload();
            } catch (e) { alert("å¤±è´¥:" + e.message); btn.disabled = false; btn.innerText = "ç¡®è®¤åŒæ­¥äº‘ç«¯"; }
        }

        // --- åŠ è½½æ•°æ®å¹¶æ¸²æŸ“ ---
        async function load() {
            const m = await _supabase.from('Market').select('*').order('created_at', {ascending:false});
            render('marketList', m.data, 'Market');
            const c = await _supabase.from('Carpool').select('*').order('created_at', {ascending:false});
            render('carpoolList', c.data, 'Carpool');
            const j = await _supabase.from('Job').select('*').order('created_at', {ascending:false});
            render('jobsList', j.data, 'Job');
        }

        function render(id, list, type) {
            const container = document.getElementById(id);
            if(!list) return;
            container.innerHTML = list.map(item => `
                <div class="card" onclick='showDetail(${JSON.stringify(item)}, "${type}")'>
                    <img src="${item.images[0] || ''}" class="card-img">
                    ${item.images.length > 1 ? `<span class="badge">å…± ${item.images.length} å¼ </span>` : ''}
                    <div class="card-body">
                        ${type === 'Market' ? `<div class="price">Â¥${item.price}</div><h4>${item.name}</h4>` : ''}
                        ${type === 'Carpool' ? `<h4>${item.route}</h4><p style="font-size:12px;color:#888">${item.time}</p>` : ''}
                        ${type === 'Job' ? `<div style="color:green;font-weight:bold">${item.pay}</div><h4>${item.title}</h4>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // --- åŸºç¡€é€»è¾‘ ---
        function switchSection(id) {
            document.querySelectorAll('.content-section, .nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
        }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }
        function doLogin() { isLogin = true; document.getElementById('loginBtn').innerText = "âœ… äº‘ç«¯å·²è¿æ¥"; alert("å·²å»ºç«‹åŠ å¯†äº‘è¿æ¥"); }

        window.onload = load;
    </script>
</body>
</html>
