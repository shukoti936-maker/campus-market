<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç”Ÿæ´»å…¨èƒ½åŠ©æ‰‹ - ç»ˆæäº‘ç«¯ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --bg: #f9fafb; --text: #1f2937; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }
        
        /* å¯¼èˆªå¤´ */
        header { background: #fff; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        nav { display: flex; gap: 15px; }
        .nav-link { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; }
        .nav-link.active { background: var(--primary); color: white; }
        
        /* ä¸»ä½“å¸ƒå±€ */
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* å†…å®¹æ˜¾éš */
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s; }
        
        /* å¡ç‰‡åˆ—è¡¨ */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
        .gallery { display: flex; overflow-x: auto; height: 200px; background: #f0f0f0; scroll-snap-type: x mandatory; }
        .gallery img { flex: 0 0 100%; width: 100%; object-fit: cover; scroll-snap-align: start; }
        .pay-badge { position: absolute; top: 10px; right: 10px; background: var(--secondary); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; z-index: 10; }
        .card-body { padding: 15px; }
        .price { color: #ef4444; font-size: 1.2rem; font-weight: 800; }

        /* å¼¹çª—ä¸é¢„è§ˆ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.open { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        
        /* å›¾ç‰‡é¢„è§ˆåŒº */
        .preview-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-item { position: relative; width: 70px; height: 70px; border: 1px solid #eee; border-radius: 6px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .remove-btn { position: absolute; top: -8px; right: -8px; background: #ff4d4f; color: white; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; cursor: pointer; text-align: center; line-height: 16px; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="switchSection('market')">ğŸ« æ ¡å›­ç”Ÿæ´»</div>
        <nav>
            <div class="nav-link active" id="nav-market" onclick="switchSection('market')">äºŒæ‰‹é›†å¸‚</div>
            <div class="nav-link" id="nav-carpool" onclick="switchSection('carpool')">æ‹¼è½¦å‡ºè¡Œ</div>
            <div class="nav-link" id="nav-jobs" onclick="switchSection('jobs')">å…¼èŒå¹¿åœº</div>
        </nav>
        <button id="loginBtn" onclick="doLogin()" style="padding: 6px 15px; border-radius: 20px; border: 1px solid #ddd; cursor: pointer;">ç”¨æˆ·ç™»å½•</button>
    </header>

    <main>
        <section id="marketSection" class="content-section active">
            <div class="section-header"><h2>äºŒæ‰‹é—²ç½®</h2><button class="btn-main" onclick="openModal('marketModal')">+ å‘å¸ƒå®è´</button></div>
            <div class="data-grid" id="marketList"></div>
        </section>

        <section id="carpoolSection" class="content-section">
            <div class="section-header"><h2>æ‹¼è½¦è¡Œç¨‹</h2><button class="btn-main" onclick="openModal('carpoolModal')">+ å‘å¸ƒè¡Œç¨‹</button></div>
            <div class="data-grid" id="carpoolList"></div>
        </section>

        <section id="jobsSection" class="content-section">
            <div class="section-header"><h2>å…¼èŒæ‹›è˜</h2><button class="btn-main" onclick="openModal('jobsModal')">+ å‘å¸ƒå…¼èŒ</button></div>
            <div class="data-grid" id="jobsList"></div>
        </section>
    </main>

    <div id="marketModal" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒäºŒæ‰‹å®è´</h3>
            <div class="form-group"><label>å•†å“åç§°</label><input type="text" id="m_title"></div>
            <div class="form-group"><label>ä»·æ ¼ (Â¥)</label><input type="number" id="m_price"></div>
            <div class="form-group"><label>è”ç³»æ–¹å¼</label><input type="text" id="m_contact"></div>
            <div class="form-group">
                <label>å®ç‰©å›¾ (å¤šå¼ )</label>
                <input type="file" id="m_imgs" multiple accept="image/*" onchange="previewImages(this, 'm_pre', 'm_files')">
                <div class="preview-grid" id="m_pre"></div>
            </div>
            <div class="form-group">
                <label style="color:var(--secondary)">ä¸Šä¼ æ”¶æ¬¾ç  (å¯é€‰)</label>
                <input type="file" id="m_qr" accept="image/*" onchange="previewImages(this, 'mq_pre', 'mq_files')">
                <div class="preview-grid" id="mq_pre"></div>
            </div>
            <button class="btn-main" style="width:100%" onclick="submitForm('Market')">ç¡®è®¤å‘å¸ƒ</button>
            <button onclick="closeModal()" style="width:100%; margin-top:10px; background:none; border:none; color:#999; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="carpoolModal" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒæ‹¼è½¦è¡Œç¨‹</h3>
            <div class="form-group"><label>è¡Œç¨‹è·¯çº¿</label><input type="text" id="c_title"></div>
            <div class="form-group"><label>å‡ºå‘æ—¶é—´</label><input type="datetime-local" id="c_time"></div>
            <div class="form-group"><label>ä»·æ ¼/è”ç³»</label><input type="text" id="c_contact"></div>
            <div class="form-group">
                <label>å›¾ç‰‡</label>
                <input type="file" id="c_imgs" multiple accept="image/*" onchange="previewImages(this, 'c_pre', 'c_files')">
                <div class="preview-grid" id="c_pre"></div>
            </div>
            <button class="btn-main" style="width:100%" onclick="submitForm('Carpool')">ç¡®è®¤å‘å¸ƒ</button>
            <button onclick="closeModal()" style="width:100%; margin-top:10px; border:none; color:#999; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="jobsModal" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒå…¼èŒæ‹›è˜</h3>
            <div class="form-group"><label>æ‹›è˜å²—ä½</label><input type="text" id="j_title"></div>
            <div class="form-group"><label>è–ªèµ„å¾…é‡</label><input type="text" id="j_pay"></div>
            <div class="form-group"><label>å·¥ä½œè¦æ±‚/è”ç³»</label><textarea id="j_contact" rows="3"></textarea></div>
            <div class="form-group">
                <label>æµ·æŠ¥</label>
                <input type="file" id="j_imgs" multiple accept="image/*" onchange="previewImages(this, 'j_pre', 'j_files')">
                <div class="preview-grid" id="j_pre"></div>
            </div>
            <button class="btn-main" style="width:100%" onclick="submitForm('Job')">ç¡®è®¤å‘å¸ƒ</button>
            <button onclick="closeModal()" style="width:100%; margin-top:10px; border:none; color:#999; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ– Supabase ---
        const SUPABASE_URL = 'https://xhcqqnpzyafvjsxyndya.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gsBzkYayDH3Z3jbEENOLrA__a7tf2TA';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLogin = false;
        let fileStores = { m_files: [], mq_files: [], c_files: [], j_files: [] };

        // --- 2. å›¾ç‰‡é¢„è§ˆä¸å¤šé€‰é€»è¾‘ ---
        function previewImages(input, preId, storeKey) {
            const files = Array.from(input.files);
            files.forEach(file => {
                fileStores[storeKey].push(file);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `<img src="${e.target.result}"><div class="remove-btn" onclick="removeImg('${storeKey}', ${fileStores[storeKey].length-1}, '${preId}')">Ã—</div>`;
                    document.getElementById(preId).appendChild(div);
                };
                reader.readAsDataURL(file);
            });
            input.value = ""; // æ¸…ç©ºinputä»¥ä¾¿é‡å¤é€‰
        }

        function removeImg(storeKey, index, preId) {
            fileStores[storeKey].splice(index, 1);
            const box = document.getElementById(preId);
            box.innerHTML = ""; // é‡æ–°æ¸²æŸ“é¢„è§ˆ
            fileStores[storeKey].forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `<img src="${e.target.result}"><div class="remove-btn" onclick="removeImg('${storeKey}', ${i}, '${preId}')">Ã—</div>`;
                    box.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // --- 3. ç™»å½•ä¸å‘å¸ƒ ---
        function doLogin() { isLogin = true; document.getElementById('loginBtn').innerText = "âœ… å·²ç™»å½•"; alert("è¿æ¥æ ¡å›­äº‘æ•°æ®åº“æˆåŠŸï¼"); }

        async function submitForm(type) {
            if(!isLogin) return alert("è¯·å…ˆç‚¹å‡»ä¸Šæ–¹'ç”¨æˆ·ç™»å½•'ï¼");
            
            let btn = event.target;
            btn.innerText = "ä¸Šä¼ ä¸­...";
            btn.disabled = true;

            try {
                // æ ¹æ®ç±»å‹è·å–å¯¹åº”çš„æ–‡ä»¶åº“
                let storeKey = type === 'Market' ? 'm_files' : (type === 'Carpool' ? 'c_files' : 'j_files');
                let urls = [];
                for(let f of fileStores[storeKey]) {
                    const fName = `${Date.now()}_${f.name}`;
                    const { data, error } = await _supabase.storage.from('images').upload(fName, f);
                    if(error) throw error;
                    const { data: { publicUrl } } = _supabase.storage.from('images').getPublicUrl(fName);
                    urls.push(publicUrl);
                }

                // æ”¶æ¬¾ç ä¸“ç”¨ä¸Šä¼ 
                let qrUrl = "";
                if(type === 'Market' && fileStores.mq_files.length > 0) {
                    const fName = `QR_${Date.now()}_qr.png`;
                    await _supabase.storage.from('images').upload(fName, fileStores.mq_files[0]);
                    qrUrl = _supabase.storage.from('images').getPublicUrl(fName).data.publicUrl;
                }

                // ç»„è£…æ•°æ®å¹¶å­˜å…¥æ•°æ®åº“
                let payload = { images: urls };
                if(type === 'Market') {
                    payload.name = document.getElementById('m_title').value;
                    payload.price = document.getElementById('m_price').value;
                    payload.contact = document.getElementById('m_contact').value;
                    payload.qr = qrUrl;
                } else if(type === 'Carpool') {
                    payload.route = document.getElementById('c_title').value;
                    payload.time = document.getElementById('c_time').value;
                    payload.contact = document.getElementById('c_contact').value;
                } else if(type === 'Job') {
                    payload.title = document.getElementById('j_title').value;
                    payload.pay = document.getElementById('j_pay').value;
                    payload.contact = document.getElementById('j_contact').value;
                }

                const { error: dbError } = await _supabase.from(type).insert([payload]);
                if(dbError) throw dbError;

                alert("å‘å¸ƒæˆåŠŸï¼");
                location.reload();
            } catch (err) {
                alert("å‘å¸ƒå¤±è´¥: " + err.message);
                btn.disabled = false;
                btn.innerText = "ç¡®è®¤å‘å¸ƒ";
            }
        }

        // --- 4. ç•Œé¢å±•ç¤ºé€»è¾‘ ---
        async function loadData() {
            const { data: mData } = await _supabase.from('Market').select('*').order('created_at', {ascending: false});
            const { data: cData } = await _supabase.from('Carpool').select('*').order('created_at', {ascending: false});
            const { data: jData } = await _supabase.from('Job').select('*').order('created_at', {ascending: false});

            render('marketList', mData, 'Market');
            render('carpoolList', cData, 'Carpool');
            render('jobsList', jData, 'Job');
        }

        function render(id, list, type) {
            const box = document.getElementById(id);
            if(!list) return box.innerHTML = "<p>æš‚æ— æ•°æ®</p>";
            box.innerHTML = list.map(item => `
                <div class="card">
                    ${item.qr ? '<span class="pay-badge">å·²é™„æ”¶æ¬¾ç </span>' : ''}
                    <div class="gallery">
                        ${(item.images || []).map(u => `<img src="${u}">`).join('')}
                    </div>
                    <div class="card-body">
                        ${type === 'Market' ? `<div class="price">Â¥${item.price}</div><h4>${item.name}</h4>` : ''}
                        ${type === 'Carpool' ? `<h4>${item.route}</h4><p>å‡ºå‘: ${item.time}</p>` : ''}
                        ${type === 'Job' ? `<div style="color:var(--secondary); font-weight:bold">${item.pay}</div><h4>${item.title}</h4>` : ''}
                        <p style="font-size:0.8rem; color:#666; margin-top:5px;">è”ç³»: ${item.contact}</p>
                    </div>
                </div>
            `).join('');
        }

        function switchSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }
        
        window.onload = loadData;
    </script>
</body>
</html>
