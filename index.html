<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç”Ÿæ´»åŠ©æ‰‹ - å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }
        
        /* å¯¼èˆªä¸æœç´¢ */
        header { background: #fff; padding: 1rem 3%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: sticky; top: 0; z-index: 1000; flex-wrap: wrap; gap: 10px; }
        .nav-group { display: flex; align-items: center; gap: 15px; }
        .search-box { position: relative; flex-grow: 1; max-width: 300px; }
        .search-box input { width: 100%; padding: 8px 35px 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 0.9rem; }
        .search-icon { position: absolute; right: 12px; top: 8px; color: #999; }
        
        nav { display: flex; gap: 5px; }
        .nav-link { padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; font-size: 0.9rem; }
        .nav-link.active { background: var(--primary); color: white; }
        
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* å¡ç‰‡ */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-3px); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card-body { padding: 12px; }
        .price { color: var(--danger); font-size: 1.1rem; font-weight: 800; }

        /* å¼¹çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 16px; max-height: 85vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #999; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 50%; }

        /* å›¾ç‰‡æµè§ˆå¢å¼º */
        .detail-gallery { display: flex; overflow-x: auto; gap: 10px; margin: 15px 0; scroll-snap-type: x mandatory; padding-bottom: 5px; }
        .detail-gallery img { width: 100px; height: 100px; object-fit: cover; flex-shrink: 0; border-radius: 8px; cursor: zoom-in; }
        
        /* å…¨å±å›¾ç‰‡é¢„è§ˆå±‚ */
        #imgViewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
        #imgViewer img { max-width: 95%; max-height: 95%; object-fit: contain; }

        /* åˆ é™¤æŒ‰é’® */
        .del-btn { background: #fee2e2; color: var(--danger); border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 20px; width: 100%; font-weight: bold; }
        
        /* è¡¨å•æ§ä»¶ */
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        label { font-size: 0.85rem; color: #666; font-weight: bold; }

        .preview-grid { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
        .preview-item { position: relative; width: 60px; height: 60px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>

    <header>
        <div class="nav-group">
            <div class="logo" onclick="location.reload()">ğŸ« æ ¡å›­åŠ©æ‰‹</div>
            <nav>
                <div class="nav-link active" id="nav-market" onclick="switchSection('market')">äºŒæ‰‹</div>
                <div class="nav-link" id="nav-carpool" onclick="switchSection('carpool')">æ‹¼è½¦</div>
                <div class="nav-link" id="nav-jobs" onclick="switchSection('jobs')">å…¼èŒ</div>
            </nav>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢å•†å“åç§°/è·¯çº¿/å²—ä½..." oninput="handleSearch()">
            <span class="search-icon">ğŸ”</span>
        </div>
        
        <button id="loginBtn" onclick="doLogin()" style="border:none; background:#eee; padding:6px 12px; border-radius:15px; font-size:12px; cursor:pointer;">å»ºç«‹äº‘è¿æ¥</button>
    </header>

    <main>
        <section id="marketSection" class="content-section active">
            <div class="section-header"><h3>äºŒæ‰‹é›†å¸‚</h3><button class="btn-main" onclick="openModal('pubMarket')">+ å‘å¸ƒ</button></div>
            <div class="data-grid" id="marketList"></div>
        </section>

        <section id="carpoolSection" class="content-section">
            <div class="section-header"><h3>æ‹¼è½¦è®¡åˆ’</h3><button class="btn-main" onclick="openModal('pubCarpool')">+ å‘å¸ƒ</button></div>
            <div class="data-grid" id="carpoolList"></div>
        </section>

        <section id="jobsSection" class="content-section">
            <div class="section-header"><h3>å…¼èŒæ‹›è˜</h3><button class="btn-main" onclick="openModal('pubJob')">+ å‘å¸ƒ</button></div>
            <div class="data-grid" id="jobsList"></div>
        </section>
    </main>

    <div id="imgViewer" onclick="this.style.display='none'">
        <img id="viewedImg" src="">
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <div id="detailContent"></div>
        </div>
    </div>

    <div id="pubMarket" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <h3>å‘å¸ƒäºŒæ‰‹å•†å“</h3>
            <input type="text" id="m_t" placeholder="å•†å“åç§°ï¼ˆæœç´¢å…³é”®è¯ï¼‰">
            <input type="number" id="m_p" placeholder="ä»·æ ¼ (Â¥)">
            <input type="text" id="m_c" placeholder="è”ç³»å¾®ä¿¡å·">
            <label>å®ç‰©å›¾ï¼š</label><input type="file" multiple onchange="handleImgs(this, 'pre_m', 'store_m')">
            <div class="preview-grid" id="pre_m"></div>
            <label>æ”¶æ¬¾ç (å¯é€‰)ï¼š</label><input type="file" onchange="handleImgs(this, 'pre_q', 'store_q')">
            <div class="preview-grid" id="pre_q"></div>
            <button class="btn-main" style="width:100%; margin-top:10px" onclick="submit('Market')">ç¡®è®¤å‘å¸ƒ</button>
        </div>
    </div>

    <div id="pubCarpool" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <h3>å‘å¸ƒæ‹¼è½¦è¡Œç¨‹</h3>
            <input type="text" id="c_t" placeholder="å‡ºå‘åœ° - ç›®çš„åœ°">
            <input type="text" id="c_time" placeholder="å‡ºå‘æ—¶é—´">
            <input type="text" id="c_c" placeholder="è”ç³»æ–¹å¼">
            <label>ç›¸å…³å›¾ç‰‡ï¼š</label><input type="file" multiple onchange="handleImgs(this, 'pre_c', 'store_c')">
            <div class="preview-grid" id="pre_c"></div>
            <button class="btn-main" style="width:100%; margin-top:10px" onclick="submit('Carpool')">ç¡®è®¤å‘å¸ƒ</button>
        </div>
    </div>

    <div id="pubJob" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <h3>å‘å¸ƒå…¼èŒæ‹›è˜</h3>
            <input type="text" id="j_t" placeholder="å²—ä½åç§°">
            <input type="text" id="j_p" placeholder="è–ªèµ„/å¾…é‡">
            <textarea id="j_d" placeholder="è¯¦ç»†è¦æ±‚" rows="3"></textarea>
            <input type="text" id="j_c" placeholder="è”ç³»æ–¹å¼">
            <label>æµ·æŠ¥/ç¯å¢ƒå›¾ï¼š</label><input type="file" multiple onchange="handleImgs(this, 'pre_j', 'store_j')">
            <div class="preview-grid" id="pre_j"></div>
            <button class="btn-main" style="width:100%; margin-top:10px" onclick="submit('Job')">ç¡®è®¤å‘å¸ƒ</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xhcqqnpzyafvjsxyndya.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gsBzkYayDH3Z3jbEENOLrA__a7tf2TA';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLogin = false;
        let globalData = { Market: [], Carpool: [], Job: [] };
        let localFiles = { store_m: [], store_q: [], store_c: [], store_j: [] };

        // --- æœç´¢åŠŸèƒ½ ---
        function handleSearch() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const currentTab = document.querySelector('.nav-link.active').id.split('-')[1];
            const tabMap = { market: 'Market', carpool: 'Carpool', jobs: 'Job' };
            const listId = currentTab + 'List';
            
            const filtered = globalData[tabMap[currentTab]].filter(item => {
                const title = (item.name || item.route || item.title || "").toLowerCase();
                return title.includes(keyword);
            });
            render(listId, filtered, tabMap[currentTab]);
        }

        // --- å›¾ç‰‡æµè§ˆåŠŸèƒ½ ---
        function viewImage(url) {
            document.getElementById('viewedImg').src = url;
            document.getElementById('imgViewer').style.display = 'flex';
        }

        // --- è¯¦æƒ…ä¸åˆ é™¤é€»è¾‘ ---
        // ã€ä¿®å¤1ã€‘æ¥æ”¶å®‰å…¨ç¼–ç åçš„å¯¹è±¡ï¼Œé˜²æ­¢å…¼èŒé‡Œçš„æ¢è¡Œç¬¦å¼•å‘ JS æŠ¥é”™
        function showDetail(itemStr, type) {
            const item = typeof itemStr === 'string' ? JSON.parse(decodeURIComponent(itemStr)) : itemStr;
            const content = document.getElementById('detailContent');
            const myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
            const isMyPost = myPosts.includes(item.id);

            let html = `
                <div class="detail-gallery">
                    ${(item.images || []).map(u => `<img src="${u}" onclick="viewImage('${u}')" title="ç‚¹å‡»æ”¾å¤§">`).join('')}
                </div>
                <div style="padding:10px 0">
                    <h2 style="color:var(--primary)">${item.name || item.route || item.title}</h2>
                    <p style="margin:10px 0"><b>è¯¦æƒ…/è”ç³»ï¼š</b>${item.contact}</p>
                    ${item.price ? `<p class="price">Â¥${item.price}</p>` : ''}
                    ${item.time ? `<p>â° æ—¶é—´ï¼š${item.time}</p>` : ''}
                    ${item.pay ? `<p>ğŸ’° è–ªèµ„ï¼š${item.pay}</p>` : ''}
                    ${item.desc ? `<p style="color:#666; font-size:0.9rem; margin-top:10px; white-space:pre-wrap;">${item.desc}</p>` : ''}
                    ${item.qr ? `<div style="text-align:center; margin-top:15px; background:#f0fdf4; padding:10px; border-radius:10px;">
                        <p style="font-size:12px; color:var(--secondary)">é•¿æŒ‰æ‰«ç æˆ–ç‚¹å‡»æ”¾å¤§</p>
                        <img src="${item.qr}" style="width:150px; cursor:pointer" onclick="viewImage(this.src)">
                    </div>` : ''}
                </div>
                ${isMyPost ? `<button class="del-btn" onclick="deletePost('${item.id}', '${type}')">ğŸ—‘ï¸ åˆ é™¤æˆ‘å‘å¸ƒçš„è¿™æ¡å†…å®¹</button>` : ''}
            `;
            // æ³¨æ„ä¸Šé¢çš„ä¸€å¤„ä¿®å¤ï¼šonclick="viewImage(this.src)" ä¿®å¤äº†åŸå…ˆäºŒç»´ç æ— æ³•æ”¾å¤§çš„é—®é¢˜
            content.innerHTML = html;
            openModal('detailModal');
        }

        async function deletePost(id, type) {
            if(!confirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡å‘å¸ƒå—ï¼Ÿ")) return;
            try {
                const { error } = await _supabase.from(type).delete().eq('id', id);
                if(error) throw error;
                alert("å·²æˆåŠŸåˆ é™¤");
                location.reload();
            } catch (e) { alert("åˆ é™¤å¤±è´¥: " + e.message); }
        }

        // --- æ ¸å¿ƒä¸Šä¼ é€»è¾‘ ---
        async function submit(type) {
            if(!isLogin) return alert("è¯·å…ˆè¿æ¥äº‘ç«¯");
            const btn = event.target;
            btn.innerText = "å¤„ç†ä¸­..."; btn.disabled = true;

            try {
                let key = type === 'Market' ? 'store_m' : (type === 'Carpool' ? 'store_c' : 'store_j');
                const imgUrls = [];
                for(let f of localFiles[key]) {
                    const fname = `${Date.now()}_${f.name}`;
                    await _supabase.storage.from('images').upload(fname, f);
                    imgUrls.push(_supabase.storage.from('images').getPublicUrl(fname).data.publicUrl);
                }

                let qrUrl = "";
                if(type === 'Market' && localFiles.store_q.length > 0) {
                    const qname = `QR_${Date.now()}.png`;
                    await _supabase.storage.from('images').upload(qname, localFiles.store_q[0]);
                    qrUrl = _supabase.storage.from('images').getPublicUrl(qname).data.publicUrl;
                }

                const payload = { 
                    images: imgUrls, 
                    contact: document.getElementById(type[0].toLowerCase()+'_c').value 
                };
                if(type === 'Market') {
                    payload.name = document.getElementById('m_t').value;
                    payload.price = document.getElementById('m_p').value;
                    payload.qr = qrUrl;
                } else if(type === 'Carpool') {
                    payload.route = document.getElementById('c_t').value;
                    payload.time = document.getElementById('c_time').value;
                } else if(type === 'Job') {
                    payload.title = document.getElementById('j_t').value;
                    payload.pay = document.getElementById('j_p').value;
                    payload.desc = document.getElementById('j_d').value;
                }

                const { data, error } = await _supabase.from(type).insert([payload]).select();
                if(error) throw error;

                const myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
                myPosts.push(data[0].id);
                localStorage.setItem('my_posts', JSON.stringify(myPosts));

                alert("å‘å¸ƒæˆåŠŸï¼");
                location.reload();
            } catch (e) { alert("é”™è¯¯: " + e.message); btn.disabled = false; btn.innerText = "ç¡®è®¤å‘å¸ƒ"; }
        }

        // --- é€šç”¨å·¥å…· ---
        // ã€ä¿®å¤2ã€‘å®Œå–„äº†å›¾ç‰‡åˆ é™¤é€»è¾‘ï¼Œç‚¹å‡»â€œÃ—â€æ—¶ä¼šæŠŠæ–‡ä»¶ä»å¾…ä¸Šä¼ åˆ—è¡¨é‡ŒçœŸå®ç§»é™¤
        function handleImgs(input, preId, key) {
            Array.from(input.files).forEach(f => {
                localFiles[key].push(f);
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `<img src="${e.target.result}"><div class="remove-btn" style="position:absolute;top:-5px;right:-5px;background:red;color:white;width:15px;height:15px;border-radius:50%;font-size:10px;text-align:center;cursor:pointer">Ã—</div>`;
                    
                    // ç»‘å®šåˆ é™¤äº‹ä»¶
                    div.querySelector('.remove-btn').onclick = function() {
                        div.remove(); // ç§»é™¤ç•Œé¢é¢„è§ˆ
                        const index = localFiles[key].indexOf(f);
                        if (index > -1) localFiles[key].splice(index, 1); // çœŸæ­£ä»ä¸Šä¼ åˆ—è¡¨ä¸­ç§»é™¤
                    };
                    
                    document.getElementById(preId).appendChild(div);
                };
                reader.readAsDataURL(f);
            });
            input.value = ''; // æ¸…ç©º input ç¼“å­˜ï¼Œè¿™æ ·å°±ç®—ä½ åˆ æ‰ä¸€å¼ å›¾åæƒ³é‡æ–°é€‰åŒä¸€å¼ å›¾ä¹Ÿä¸ä¼šå‡º Bug
        }

        async function load() {
            const { data: m } = await _supabase.from('Market').select('*').order('created_at', {ascending:false});
            const { data: c } = await _supabase.from('Carpool').select('*').order('created_at', {ascending:false});
            const { data: j } = await _supabase.from('Job').select('*').order('created_at', {ascending:false});
            globalData = { Market: m||[], Carpool: c||[], Job: j||[] };
            render('marketList', globalData.Market, 'Market');
            render('carpoolList', globalData.Carpool, 'Carpool');
            render('jobsList', globalData.Job, 'Job');
        }

        function render(id, list, type) {
            const container = document.getElementById(id);
            // ã€ä¿®å¤3ã€‘ä½¿ç”¨ encodeURIComponent ä¿è¯æ— è®ºç”¨æˆ·åœ¨å…¼èŒè¯¦æƒ…é‡Œæ¢è¡Œè¿˜æ˜¯æ‰“å¼•å·ï¼Œä»£ç éƒ½ä¸ä¼šæŠ¥é”™
            container.innerHTML = list.map(item => {
                const safeItemStr = encodeURIComponent(JSON.stringify(item));
                return `
                <div class="card" onclick='showDetail("${safeItemStr}", "${type}")'>
                    <img src="${(item.images && item.images.length > 0) ? item.images[0] : ''}" class="card-img">
                    <div class="card-body">
                        ${type==='Market' ? `<div class="price">Â¥${item.price}</div><h4>${item.name}</h4>` : ''}
                        ${type==='Carpool' ? `<h4>${item.route}</h4><p style="font-size:12px;color:#888">${item.time}</p>` : ''}
                        ${type==='Job' ? `<div style="color:var(--secondary);font-weight:bold">${item.pay}</div><h4>${item.title}</h4>` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function switchSection(id) {
            document.querySelectorAll('.content-section, .nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
            handleSearch();
        }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }
        function doLogin() { isLogin = true; document.getElementById('loginBtn').innerText = "âœ… äº‘è¿æ¥å·²å»ºç«‹"; alert("å·²æ¥å…¥æ ¡å›­äº‘æ•°æ®åº“"); }

        window.onload = load;
    </script>
</body>
</html>
