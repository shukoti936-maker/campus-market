<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç”Ÿæ´»åŠ©æ‰‹ - å¢å¼ºéªŒè¯ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }
        
        header { background: #fff; padding: 1rem 3%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: sticky; top: 0; z-index: 1000; flex-wrap: wrap; gap: 10px; }
        .nav-group { display: flex; align-items: center; gap: 15px; }
        .search-box { position: relative; flex-grow: 1; max-width: 300px; }
        .search-box input { width: 100%; padding: 8px 35px 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 0.9rem; }
        .search-icon { position: absolute; right: 12px; top: 8px; color: #999; }
        
        nav { display: flex; gap: 5px; }
        .nav-link { padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; font-size: 0.9rem; }
        .nav-link.active { background: var(--primary); color: white; }
        
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-3px); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; display: block; }
        .card-body { padding: 12px; }
        .price { color: var(--danger); font-size: 1.1rem; font-weight: 800; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 16px; max-height: 85vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #999; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 50%; z-index: 10; }

        .detail-gallery { display: flex; overflow-x: auto; gap: 10px; margin: 15px 0; padding-bottom: 10px; }
        .detail-gallery img { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; cursor: zoom-in; flex-shrink: 0; background: #f9f9f9; }
        
        #imgViewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
        #imgViewer img { max-width: 95%; max-height: 95%; object-fit: contain; }

        .del-btn { background: #fee2e2; color: var(--danger); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin-top: 20px; width: 100%; font-weight: bold; }
        
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem; }
        label { font-size: 0.85rem; color: #666; font-weight: bold; }

        .preview-grid { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
        .preview-item { position: relative; width: 60px; height: 60px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>

    <header>
        <div class="nav-group">
            <div class="logo" onclick="location.reload()" style="cursor:pointer; font-weight:bold; font-size:1.2rem;">ğŸ« æ ¡å›­åŠ©æ‰‹</div>
            <nav>
                <div class="nav-link active" id="nav-market" onclick="switchSection('market')">äºŒæ‰‹</div>
                <div class="nav-link" id="nav-carpool" onclick="switchSection('carpool')">æ‹¼è½¦</div>
                <div class="nav-link" id="nav-jobs" onclick="switchSection('jobs')">å…¼èŒ</div>
            </nav>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢å…³é”®è¯..." oninput="handleSearch()">
            <span class="search-icon">ğŸ”</span>
        </div>
        
        <button id="loginBtn" onclick="openAuthModal()" style="border:none; background:#eee; padding:8px 15px; border-radius:20px; font-size:12px; cursor:pointer; font-weight:bold;">å»ºç«‹äº‘è¿æ¥</button>
    </header>

    <main>
        <section id="marketSection" class="content-section active">
            <div class="section-header"><h3>äºŒæ‰‹é›†å¸‚</h3><button class="btn-main" onclick="openModal('pubMarket')">+ å‘å¸ƒå•†å“</button></div>
            <div class="data-grid" id="marketList"></div>
        </section>

        <section id="carpoolSection" class="content-section">
            <div class="section-header"><h3>æ‹¼è½¦è®¡åˆ’</h3><button class="btn-main" onclick="openModal('pubCarpool')">+ å‘å¸ƒè¡Œç¨‹</button></div>
            <div class="data-grid" id="carpoolList"></div>
        </section>

        <section id="jobsSection" class="content-section">
            <div class="section-header"><h3>å…¼èŒæ‹›è˜</h3><button class="btn-main" onclick="openModal('pubJob')">+ å‘å¸ƒå²—ä½</button></div>
            <div class="data-grid" id="jobsList"></div>
        </section>
    </main>

    <div id="imgViewer" onclick="this.style.display='none'">
        <img id="viewedImg" src="">
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <h3 style="margin-bottom: 10px;">èº«ä»½éªŒè¯</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 20px;">é¦–æ¬¡ç™»å½•åï¼Œä¸‰ä¸ªæœˆå†…å…é‡å¤éªŒè¯</p>
            
            <div id="loginFormArea">
                <input type="email" id="emailInput" placeholder="è¾“å…¥é‚®ç®±è·å–éªŒè¯ç " style="text-align:center;">
                <button class="btn-main" id="sendEmailBtn" onclick="handleEmailLogin()" style="width:100%; margin-top:15px;">å‘é€éªŒè¯ç </button>
                
                <div id="verifyArea" style="display: none; margin-top: 15px; background: #f9fafb; padding: 15px; border-radius: 8px;">
                    <label style="display: block; text-align: left; margin-bottom: 5px;">è¯·è¾“å…¥é‚®ç®±æ”¶åˆ°çš„éªŒè¯ç ï¼š</label>
                    <input type="text" id="codeInput" placeholder="è¾“å…¥æ•°å­—" style="text-align:center; letter-spacing: 5px; font-size: 1.2rem; font-weight: bold;">
                    <button class="btn-main" onclick="handleVerifyCode()" style="width:100%; margin-top:10px; background: var(--secondary);">ç¡®è®¤å¹¶åœ¨æœ¬é¡µç™»å½•</button>
                </div>

                <p style="font-size: 11px; color: #999; margin-top: 15px;">æç¤ºï¼šè¯·ä¸è¦å…³é—­æ­¤é¡µé¢ï¼Œå»é‚®ç®±æŸ¥çœ‹éªŒè¯ç åè¿”å›è¿™é‡Œè¾“å…¥ã€‚</p>
            </div>

            <div id="userInfoArea" style="display: none;">
                <p style="margin-bottom: 20px; font-size: 14px;">
                    å½“å‰ç™»å½•è´¦å·ï¼š<br>
                    <strong id="displayUserEmail" style="color: var(--primary); font-size: 16px;"></strong>
                </p>
                <button class="del-btn" onclick="handleLogout()" style="margin-top: 0;">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <div id="detailContent"></div>
        </div>
    </div>

    <div id="pubMarket" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <h3>å‘å¸ƒäºŒæ‰‹å•†å“</h3>
            <input type="text" id="m_t" placeholder="å•†å“åç§°">
            <input type="number" id="m_p" placeholder="ä»·æ ¼ (Â¥)">
            <input type="text" id="m_c" placeholder="è”ç³»å¾®ä¿¡å·">
            <label>ä¸Šä¼ å®ç‰©å›¾ï¼ˆå¤šé€‰ï¼‰ï¼š</label>
            <input type="file" multiple accept="image/*" onchange="handleImgs(this, 'pre_m', 'store_m')">
            <div class="preview-grid" id="pre_m"></div>
            <label>æ”¶æ¬¾ç (å¯é€‰)ï¼š</label>
            <input type="file" accept="image/*" onchange="handleImgs(this, 'pre_q', 'store_q')">
            <div class="preview-grid" id="pre_q"></div>
            <button class="btn-main" style="width:100%; margin-top:10px" onclick="submit('Market')">ç¡®è®¤å‘å¸ƒ</button>
        </div>
    </div>

    <div id="pubCarpool" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <h3>å‘å¸ƒæ‹¼è½¦è¡Œç¨‹</h3>
            <input type="text" id="c_t" placeholder="å‡ºå‘åœ° - ç›®çš„åœ°">
            <input type="text" id="c_time" placeholder="å‡ºå‘æ—¶é—´ï¼ˆå¦‚ï¼šæ˜æ—¥ä¸‹åˆ2ç‚¹ï¼‰">
            <input type="text" id="c_c" placeholder="è”ç³»å¾®ä¿¡å·/æ‰‹æœºå·">
            <label>è¡Œç¨‹ç›¸å…³å›¾ï¼š</label>
            <input type="file" multiple accept="image/*" onchange="handleImgs(this, 'pre_c', 'store_c')">
            <div class="preview-grid" id="pre_c"></div>
            <button class="btn-main" style="width:100%; margin-top:10px" onclick="submit('Carpool')">ç¡®è®¤å‘å¸ƒ</button>
        </div>
    </div>

    <div id="pubJob" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal()">Ã—</div>
            <h3>å‘å¸ƒå…¼èŒæ‹›è˜</h3>
            <input type="text" id="j_t" placeholder="å²—ä½åç§°">
            <input type="text" id="j_p" placeholder="è–ªèµ„/å¾…é‡ï¼ˆå¦‚ï¼š200/å¤©ï¼‰">
            <textarea id="j_d" placeholder="å·¥ä½œå†…å®¹åŠè¦æ±‚" rows="4"></textarea>
            <input type="text" id="j_c" placeholder="è”ç³»äººåŠè”ç³»æ–¹å¼">
            <label>æµ·æŠ¥/ç¯å¢ƒå›¾ï¼š</label>
            <input type="file" multiple accept="image/*" onchange="handleImgs(this, 'pre_j', 'store_j')">
            <div class="preview-grid" id="pre_j"></div>
            <button class="btn-main" style="width:100%; margin-top:10px" onclick="submit('Job')">ç¡®è®¤å‘å¸ƒ</button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Supabase
        const SUPABASE_URL = 'https://xhcqqnpzyafvjsxyndya.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gsBzkYayDH3Z3jbEENOLrA__a7tf2TA';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLogin = false;
        let globalData = { Market: [], Carpool: [], Job: [] };
        let localFiles = { store_m: [], store_q: [], store_c: [], store_j: [] };

        const PLACEHOLDER = 'https://via.placeholder.com/300x180?text=No+Image';

        function getSafeImg(imgData) {
            if (Array.isArray(imgData) && imgData.length > 0) return imgData[0];
            if (typeof imgData === 'string' && imgData.startsWith('http')) return imgData;
            return PLACEHOLDER;
        }

        // ================= ä¿®æ­£åçš„éªŒè¯é€»è¾‘ =================

        async function checkSession() {
            const { data: { session }, error } = await _supabase.auth.getSession();
            if (session) {
                updateLoginState(true, session.user.email);
            } else {
                updateLoginState(false, null);
            }

            _supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    updateLoginState(true, session.user.email);
                    closeModal(); 
                } else if (event === 'SIGNED_OUT') {
                    updateLoginState(false, null);
                }
            });
        }

        function updateLoginState(loggedIn, email) {
            isLogin = loggedIn;
            const btn = document.getElementById('loginBtn');
            
            if (loggedIn && email) {
                btn.innerText = "âœ… å·²ç™»å½•"; 
                btn.style.background = "#dcfce7";
                btn.style.color = "#166534";
                document.getElementById('loginFormArea').style.display = 'none';
                document.getElementById('userInfoArea').style.display = 'block';
                document.getElementById('displayUserEmail').innerText = email;
            } else {
                btn.innerText = "å»ºç«‹äº‘è¿æ¥"; 
                btn.style.background = "#eee";
                btn.style.color = "#000";
                document.getElementById('loginFormArea').style.display = 'block';
                document.getElementById('userInfoArea').style.display = 'none';
                document.getElementById('verifyArea').style.display = 'none';
                document.getElementById('codeInput').value = '';
            }
        }

        function openAuthModal() {
            openModal('authModal');
        }

        async function handleEmailLogin() {
            const email = document.getElementById('emailInput').value.trim();
            const btn = document.getElementById('sendEmailBtn');

            if (!email || !email.includes('@')) {
                return alert("è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€");
            }

            btn.disabled = true;
            let timer = 60;
            const originalBg = btn.style.background;
            btn.style.background = "#9ca3af";

            const interval = setInterval(() => {
                btn.innerText = `ç­‰å¾… ${timer}s`;
                if (timer <= 0) {
                    clearInterval(interval);
                    btn.disabled = false;
                    btn.innerText = "é‡æ–°è·å–éªŒè¯ç ";
                    btn.style.background = originalBg;
                }
                timer--;
            }, 1000);

            // è°ƒç”¨ Supabase å‘é€é‚®ä»¶
            const { error } = await _supabase.auth.signInWithOtp({
                email: email
            });

            if (error) {
                alert("å‘é€å¤±è´¥: " + error.message);
                clearInterval(interval);
                btn.disabled = false;
                btn.innerText = "é‡æ–°å‘é€";
                btn.style.background = originalBg;
            } else {
                document.getElementById('verifyArea').style.display = 'block';
                alert("âœ… éªŒè¯ç å·²å‘é€ï¼\nè¯·å»é‚®ç®±æŸ¥çœ‹éªŒè¯ç ï¼Œå¹¶åœ¨ä¸‹æ–¹è¾“å…¥ã€‚");
            }
        }

        async function handleVerifyCode() {
            const email = document.getElementById('emailInput').value.trim();
            const code = document.getElementById('codeInput').value.trim();
            const btn = event.target;

            if (!code) {
                return alert("è¯·è¾“å…¥éªŒè¯ç ");
            }

            const originalText = btn.innerText;
            btn.innerText = "æ­£åœ¨éªŒè¯...";
            btn.disabled = true;

            const { data, error } = await _supabase.auth.verifyOtp({
                email: email,
                token: code,
                type: 'magiclink' 
            });

            if (error) {
                alert("éªŒè¯å¤±è´¥: " + error.message);
                btn.disabled = false;
                btn.innerText = originalText;
            } else {
                alert("âœ… ç™»å½•æˆåŠŸï¼");
            }
        }

        async function handleLogout() {
            if(confirm("ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ")) {
                await _supabase.auth.signOut();
                location.reload();
            }
        }

        // ================= å…¶ä½™åŠŸèƒ½ä¿æŒä¸å˜ =================

        function handleSearch() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const currentTab = document.querySelector('.nav-link.active').id.split('-')[1];
            const tabMap = { market: 'Market', carpool: 'Carpool', jobs: 'Job' };
            const type = tabMap[currentTab];
            const listId = currentTab + 'List';
            
            const filtered = globalData[type].filter(item => {
                const title = (item.name || item.route || item.title || "").toLowerCase();
                return title.includes(keyword);
            });
            render(listId, filtered, type);
        }

        function viewImage(url) {
            if(!url || url === PLACEHOLDER) return;
            document.getElementById('viewedImg').src = url;
            document.getElementById('imgViewer').style.display = 'flex';
        }

        // ================= å¢åŠ äº†å‰ç«¯æ‹¦æˆªé€»è¾‘çš„è¯¦æƒ…å±•ç¤ºå‡½æ•° =================
        function showDetail(type, index) {
            // æ‹¦æˆªæ£€æŸ¥ï¼šå¦‚æœæœªç™»å½•ï¼Œåˆ™ä¸æ˜¾ç¤ºè¯¦æƒ…å†…å®¹
            if (!isLogin) {
                alert("ğŸ” è¯·å…ˆå»ºç«‹äº‘è¿æ¥éªŒè¯èº«ä»½åï¼Œå³å¯æŸ¥çœ‹è¯¦ç»†è”ç³»æ–¹å¼åŠå†…å®¹ã€‚");
                openAuthModal(); // è‡ªåŠ¨å¼¹å‡ºç™»å½•æ¡†
                return;
            }

            const item = globalData[type][index];
            if(!item) return;

            const content = document.getElementById('detailContent');
            const myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
            const isMyPost = myPosts.includes(item.id);
            const images = Array.isArray(item.images) ? item.images : [];

            let html = `
                <div class="detail-gallery">
                    ${images.length > 0 ? 
                        images.map(u => `<img src="${u}" onclick="viewImage('${u}')" onerror="this.src='${PLACEHOLDER}'">`).join('') :
                        `<img src="${PLACEHOLDER}" style="cursor:default">`
                    }
                </div>
                <div style="padding:10px 0">
                    <h2 style="color:var(--primary); margin-bottom:15px">${item.name || item.route || item.title}</h2>
                    <div style="background:#f9fafb; padding:15px; border-radius:12px; margin-bottom:15px">
                        <p style="margin-bottom:8px"><b>ğŸ“± è”ç³»æ–¹å¼ï¼š</b><span style="color:var(--primary); font-weight:bold">${item.contact || 'æœªå¡«å†™'}</span></p>
                        ${item.price ? `<p style="margin-bottom:8px"><b>ğŸ’° ä»·æ ¼ï¼š</b><span class="price">Â¥${item.price}</span></p>` : ''}
                        ${item.time ? `<p style="margin-bottom:8px"><b>â° å‡ºå‘æ—¶é—´ï¼š</b>${item.time}</p>` : ''}
                        ${item.pay ? `<p style="margin-bottom:8px"><b>ğŸ’ è–ªèµ„å¾…é‡ï¼š</b><span style="color:var(--secondary); font-weight:bold">${item.pay}</span></p>` : ''}
                    </div>
                    ${item.desc ? `<p style="white-space:pre-wrap; background:#fff; border-left:4px solid #ddd; padding-left:10px; margin:15px 0;">${item.desc}</p>` : ''}
                    ${item.qr ? `<div style="text-align:center;"><img src="${item.qr}" style="width:180px;" onclick="viewImage(this.src)"></div>` : ''}
                </div>
                ${isMyPost ? `<button class="del-btn" onclick="deletePost('${item.id}', '${type}')">ğŸ—‘ï¸ åˆ é™¤æ­¤æ¡å‘å¸ƒ</button>` : ''}
            `;
            content.innerHTML = html;
            openModal('detailModal');
        }

        async function deletePost(id, type) {
            if(!confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ")) return;
            try {
                const { error } = await _supabase.from(type).delete().eq('id', id);
                if(error) throw error;
                alert("å·²åˆ é™¤");
                location.reload();
            } catch (e) { alert("åˆ é™¤å¤±è´¥: " + e.message); }
        }

        async function submit(type) {
            if(!isLogin) return alert("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’å»ºç«‹è¿æ¥å¹¶éªŒè¯èº«ä»½ï¼");
            const btn = event.target;
            const contactVal = document.getElementById(type[0].toLowerCase()+'_c').value;
            if(!contactVal) return alert("è¯·å¡«å†™è”ç³»æ–¹å¼");

            btn.innerText = "æ­£åœ¨å‘å¸ƒ..."; btn.disabled = true;

            try {
                let key = type === 'Market' ? 'store_m' : (type === 'Carpool' ? 'store_c' : 'store_j');
                const imgUrls = [];
                for(let f of localFiles[key]) {
                    const fname = `public/${Date.now()}_${f.name.replace(/[^\x00-\x7F]/g, "")}`;
                    const { error } = await _supabase.storage.from('images').upload(fname, f);
                    if(error) throw error;
                    imgUrls.push(_supabase.storage.from('images').getPublicUrl(fname).data.publicUrl);
                }

                let qrUrl = "";
                if(type === 'Market' && localFiles.store_q.length > 0) {
                    const qname = `qr/QR_${Date.now()}.png`;
                    await _supabase.storage.from('images').upload(qname, localFiles.store_q[0]);
                    qrUrl = _supabase.storage.from('images').getPublicUrl(qname).data.publicUrl;
                }

                const payload = { images: imgUrls, contact: contactVal };
                if(type === 'Market') {
                    payload.name = document.getElementById('m_t').value || "æœªå‘½å";
                    payload.price = document.getElementById('m_p').value || "0";
                    payload.qr = qrUrl;
                } else if(type === 'Carpool') {
                    payload.route = document.getElementById('c_t').value || "æœªå®š";
                    payload.time = document.getElementById('c_time').value || "éšæ—¶";
                } else if(type === 'Job') {
                    payload.title = document.getElementById('j_t').value || "å²—ä½";
                    payload.pay = document.getElementById('j_p').value || "é¢è®®";
                    payload.desc = document.getElementById('j_d').value || "";
                }

                const { data, error } = await _supabase.from(type).insert([payload]).select();
                if(error) throw error;

                const myPosts = JSON.parse(localStorage.getItem('my_posts') || '[]');
                myPosts.push(data[0].id);
                localStorage.setItem('my_posts', JSON.stringify(myPosts));

                alert("å‘å¸ƒæˆåŠŸ");
                location.reload();
            } catch (e) { 
                alert("å‘å¸ƒå¤±è´¥: " + e.message); 
                btn.disabled = false; btn.innerText = "ç¡®è®¤å‘å¸ƒ"; 
            }
        }

        function handleImgs(input, preId, key) {
            Array.from(input.files).forEach(f => {
                localFiles[key].push(f);
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `<img src="${e.target.result}"><div style="position:absolute;top:-5px;right:-5px;background:var(--danger);color:white;width:18px;height:18px;border-radius:50%;text-align:center;cursor:pointer;">Ã—</div>`;
                    div.onclick = () => { div.remove(); localFiles[key] = localFiles[key].filter(file => file !== f); };
                    document.getElementById(preId).appendChild(div);
                };
                reader.readAsDataURL(f);
            });
            input.value = '';
        }

        async function load() {
            try {
                const { data: m } = await _supabase.from('Market').select('*').order('created_at', {ascending:false});
                const { data: c } = await _supabase.from('Carpool').select('*').order('created_at', {ascending:false});
                const { data: j } = await _supabase.from('Job').select('*').order('created_at', {ascending:false});
                globalData = { Market: m||[], Carpool: c||[], Job: j||[] };
                render('marketList', globalData.Market, 'Market');
                render('carpoolList', globalData.Carpool, 'Carpool');
                render('jobsList', globalData.Job, 'Job');
            } catch (e) { console.log("åŠ è½½å¤±è´¥:", e.message); }
        }

        function render(id, list, type) {
            const container = document.getElementById(id);
            if(!list || list.length === 0) {
                container.innerHTML = `<p style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">æš‚æ— å†…å®¹</p>`;
                return;
            }
            container.innerHTML = list.map((item, index) => `
                <div class="card" onclick="showDetail('${type}', ${index})">
                    <img src="${getSafeImg(item.images)}" class="card-img" onerror="this.src='${PLACEHOLDER}'">
                    <div class="card-body">
                        ${type==='Market' ? `<div class="price">Â¥${item.price}</div><h4>${item.name}</h4>` : ''}
                        ${type==='Carpool' ? `<h4>${item.route}</h4><p>â° ${item.time}</p>` : ''}
                        ${type==='Job' ? `<div style="color:var(--secondary);font-weight:bold">${item.pay}</div><h4>${item.title}</h4>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function switchSection(id) {
            document.querySelectorAll('.content-section, .nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
        }
        
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }
        
        window.onload = async () => {
            await checkSession();
            await load();
        };
    </script>
</body>
</html>
