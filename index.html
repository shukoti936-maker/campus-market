<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç”Ÿæ´»å…¨èƒ½åŠ©æ‰‹ - Supabase äº‘ç«¯ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --accent: #f59e0b; --bg: #f9fafb; --text: #1f2937; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', system-ui; }
        body { background: var(--bg); color: var(--text); padding-bottom: 40px; }
        header { background: #fff; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        nav { display: flex; gap: 10px; }
        .nav-link { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; color: #666; }
        .nav-link.active { background: var(--primary); color: white; }
        main { max-width: 1200px; margin: 25px auto; padding: 0 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-left: 5px solid var(--primary); padding-left: 15px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .loading-view { text-align: center; padding: 50px; color: var(--primary); font-weight: bold; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
        .gallery-wrapper { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: 200px; background: #eee; scrollbar-width: none; }
        .gallery-img { flex: 0 0 100%; width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; }
        .img-count-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; z-index: 5; }
        .pay-badge { position: absolute; top: 10px; right: 10px; background: var(--secondary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; z-index: 5; }
        .card-body { padding: 15px; }
        .price-tag { color: #ef4444; font-size: 1.2rem; font-weight: 800; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.open { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; }
        .preview-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-item { position: relative; width: 80px; height: 80px; border-radius: 8px; border: 1px solid #ddd; }
        .preview-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .remove-btn { position: absolute; top: -8px; right: -8px; background: #ff4d4f; color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 18px; cursor: pointer; border: 2px solid white; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="goHome()">ğŸ« CampusLife</div>
        <nav>
            <div class="nav-link active" id="nav-market" onclick="switchSection('market')">äºŒæ‰‹é›†å¸‚</div>
            <div class="nav-link" id="nav-carpool" onclick="switchSection('carpool')">æ‹¼è½¦å‡ºè¡Œ</div>
            <div class="nav-link" id="nav-jobs" onclick="switchSection('jobs')">å…¼èŒå¹¿åœº</div>
        </nav>
        <div class="user-section">
            <button id="loginBtn" class="login-btn" onclick="handleLogin()" style="padding: 8px 18px; border-radius: 20px; cursor: pointer; background: #333; color: white; border: none;">ç”¨æˆ·ç™»å½•</button>
            <div id="userProfile" style="display:none; font-weight:bold;">å·²è¿æ¥äº‘ç«¯ âœ…</div>
        </div>
    </header>

    <main>
        <div id="loading" class="loading-view">æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</div>

        <section id="marketSection" class="content-section active">
            <div class="section-header"><h2>äºŒæ‰‹é—²ç½®å®è´</h2><button class="btn-main" onclick="openModal('marketModal')">+ å‘å¸ƒå•†å“</button></div>
            <div class="data-grid" id="marketList"></div>
        </section>

        <section id="carpoolSection" class="content-section">
            <div class="section-header"><h2>æ‹¼è½¦/ç§Ÿè½¦è¡Œç¨‹</h2><button class="btn-main" onclick="openModal('carpoolModal')">+ å‘å¸ƒè¡Œç¨‹</button></div>
            <div class="data-grid" id="carpoolList"></div>
        </section>

        <section id="jobsSection" class="content-section">
            <div class="section-header"><h2>æ ¡å›­å…¼èŒæ‹›å‹Ÿ</h2><button class="btn-main" onclick="openModal('jobsModal')">+ å‘å¸ƒå…¼èŒ</button></div>
            <div class="data-grid" id="jobsList"></div>
        </section>
    </main>

    <div id="marketModal" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒäºŒæ‰‹å•†å“</h3>
            <form onsubmit="handleSubmit(event, 'Market')">
                <div class="form-group"><label>å•†å“åç§°</label><input type="text" id="m_name" required></div>
                <div class="form-group"><label>ä»·æ ¼ (Â¥)</label><input type="number" id="m_price" required></div>
                <div class="form-group"><label>è”ç³»æ–¹å¼</label><input type="text" id="m_contact" required></div>
                <div class="form-group"><label>å®ç‰©å›¾</label><input type="file" accept="image/*" multiple onchange="imgMgr.handleSelect(this, 'market')"><div class="preview-grid" id="pre_market"></div></div>
                <div class="form-group"><label style="color:var(--secondary)">ä¸Šä¼ æ”¶æ¬¾ç  (å¯é€‰)</label><input type="file" accept="image/*" onchange="imgMgr.handleQr(this)"><div class="preview-grid" id="pre_market_qr"></div></div>
                <button type="submit" class="btn-main" style="width:100%">ç¡®è®¤å‘å¸ƒåˆ°äº‘ç«¯</button>
                <button type="button" class="btn-main" style="width:100%; margin-top:10px; background:#999" onclick="closeAllModals()">è¿”å›</button>
            </form>
        </div>
    </div>

    <div id="carpoolModal" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒæ‹¼è½¦è¡Œç¨‹</h3>
            <form onsubmit="handleSubmit(event, 'Carpool')">
                <div class="form-group"><label>è·¯çº¿</label><input type="text" id="c_route" required></div>
                <div class="form-group"><label>æ—¶é—´</label><input type="datetime-local" id="c_time" required></div>
                <div class="form-group"><label>è´¹ç”¨/äºº</label><input type="number" id="c_price" required></div>
                <div class="form-group"><label>è”ç³»æ–¹å¼</label><input type="text" id="c_contact" required></div>
                <div class="form-group"><label>ç›¸å…³å›¾</label><input type="file" accept="image/*" multiple onchange="imgMgr.handleSelect(this, 'carpool')"><div class="preview-grid" id="pre_carpool"></div></div>
                <button type="submit" class="btn-main" style="width:100%">ç¡®è®¤å‘å¸ƒåˆ°äº‘ç«¯</button>
                <button type="button" class="btn-main" style="width:100%; margin-top:10px; background:#999" onclick="closeAllModals()">è¿”å›</button>
            </form>
        </div>
    </div>

    <div id="jobsModal" class="modal">
        <div class="modal-content">
            <h3>å‘å¸ƒå…¼èŒå²—ä½</h3>
            <form onsubmit="handleSubmit(event, 'Job')">
                <div class="form-group"><label>èŒä½</label><input type="text" id="j_title" required></div>
                <div class="form-group"><label>è–ªèµ„</label><input type="text" id="j_pay" required></div>
                <div class="form-group"><label>æè¿°</label><textarea id="j_desc" rows="2"></textarea></div>
                <div class="form-group"><label>è”ç³»æ–¹å¼</label><input type="text" id="j_contact" required></div>
                <div class="form-group"><label>æµ·æŠ¥</label><input type="file" accept="image/*" multiple onchange="imgMgr.handleSelect(this, 'jobs')"><div class="preview-grid" id="pre_jobs"></div></div>
                <button type="submit" class="btn-main" style="width:100%">ç¡®è®¤å‘å¸ƒåˆ°äº‘ç«¯</button>
                <button type="button" class="btn-main" style="width:100%; margin-top:10px; background:#999" onclick="closeAllModals()">è¿”å›</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. é…ç½®é’¥åŒ™ (å·²å¡«å…¥ä½ çš„ä¸“å±ä¿¡æ¯) ---
        const SUPABASE_URL = 'https://xhcqqnpzyafvjsxyndya.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gsBzkYayDH3Z3jbEENOLrA__a7tf2TA';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLogin = false;

        // --- 2. å›¾ç‰‡å¤„ç†é€»è¾‘ ---
        const imgMgr = {
            staged: { market: [], carpool: [], jobs: [] },
            marketQrFile: null,
            handleSelect(input, type) {
                if (input.files) {
                    Array.from(input.files).forEach(file => {
                        this.staged[type].push(file);
                        this.renderPre(type);
                    });
                }
            },
            handleQr(input) {
                if (input.files[0]) {
                    this.marketQrFile = input.files[0];
                    const reader = new FileReader();
                    reader.onload = e => {
                        document.getElementById('pre_market_qr').innerHTML = `
                            <div class="preview-item">
                                <img src="${e.target.result}" class="preview-img">
                                <div class="remove-btn" onclick="imgMgr.marketQrFile=null;imgMgr.renderQrPre()">Ã—</div>
                            </div>`;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            renderPre(type) {
                const box = document.getElementById('pre_' + type);
                box.innerHTML = '';
                this.staged[type].forEach((file, i) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const div = document.createElement('div');
                        div.className = 'preview-item';
                        div.innerHTML = `<img src="${e.target.result}" class="preview-img"><div class="remove-btn" onclick="imgMgr.remove('${type}', ${i})">Ã—</div>`;
                        box.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            },
            remove(type, i) { this.staged[type].splice(i, 1); this.renderPre(type); },
            renderQrPre() { document.getElementById('pre_market_qr').innerHTML = ''; }
        };

        // --- 3. ä¸Šä¼ åˆ° Storage ---
        async function uploadToStorage(file) {
            const fileName = `${Date.now()}_${file.name}`;
            const { data, error } = await _supabase.storage
                .from('images')
                .upload(fileName, file);
            if (error) throw error;
            const { data: { publicUrl } } = _supabase.storage.from('images').getPublicUrl(fileName);
            return publicUrl;
        }

        // --- 4. æäº¤æ•°æ® ---
        async function handleSubmit(e, className) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerText = "æ­£åœ¨å‘å¸ƒ...";
            btn.disabled = true;

            try {
                const typeKey = { 'Market': 'market', 'Carpool': 'carpool', 'Job': 'jobs' }[className];
                
                const imageUrls = [];
                for (let file of imgMgr.staged[typeKey]) {
                    const url = await uploadToStorage(file);
                    imageUrls.push(url);
                }

                let qrUrl = '';
                if (className === 'Market' && imgMgr.marketQrFile) {
                    qrUrl = await uploadToStorage(imgMgr.marketQrFile);
                }

                const payload = { images: imageUrls };
                if (className === 'Market') {
                    payload.name = document.getElementById('m_name').value;
                    payload.price = parseFloat(document.getElementById('m_price').value);
                    payload.contact = document.getElementById('m_contact').value;
                    payload.qr = qrUrl;
                } else if (className === 'Carpool') {
                    payload.route = document.getElementById('c_route').value;
                    payload.time = document.getElementById('c_time').value;
                    payload.price = parseFloat(document.getElementById('c_price').value);
                    payload.contact = document.getElementById('c_contact').value;
                } else if (className === 'Job') {
                    payload.title = document.getElementById('j_title').value;
                    payload.pay = document.getElementById('j_pay').value;
                    payload.desc = document.getElementById('j_desc').value;
                    payload.contact = document.getElementById('j_contact').value;
                }

                const { error } = await _supabase.from(className).insert([payload]);
                if (error) throw error;

                alert("å‘å¸ƒæˆåŠŸï¼");
                location.reload();
            } catch (err) {
                alert("å¤±è´¥: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç¡®è®¤å‘å¸ƒåˆ°äº‘ç«¯";
            }
        }

        // --- 5. æ‹‰å–æ•°æ® ---
        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            try {
                await Promise.all([fetchList('Market'), fetchList('Carpool'), fetchList('Job')]);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function fetchList(className) {
            const { data: results, error } = await _supabase
                .from(className).select('*').order('created_at', { ascending: false });
            
            if (error) return console.error(error);
            const listId = { 'Market': 'marketList', 'Carpool': 'carpoolList', 'Job': 'jobsList' }[className];
            const box = document.getElementById(listId);
            box.innerHTML = results.map(item => {
                const imgs = (item.images && item.images.length) ? item.images : ['https://via.placeholder.com/400x250?text=No+Image'];
                return `
                    <div class="card">
                        ${item.qr ? '<span class="pay-badge">å·²é™„æ”¶æ¬¾ç </span>' : ''}
                        <div class="gallery-wrapper">
                            ${imgs.length > 1 ? `<span class="img-count-badge">å…± ${imgs.length} å¼ </span>` : ''}
                            ${imgs.map(src => `<img src="${src}" class="gallery-img">`).join('')}
                        </div>
                        <div class="card-body">
                            ${className === 'Market' ? `<div class="price-tag">Â¥${item.price}</div><h3>${item.name}</h3>` : ''}
                            ${className === 'Carpool' ? `<h3>${item.route}</h3><div style="font-size:0.8rem;color:#666">â° ${item.time}</div><div class="price-tag">Â¥${item.price}/äºº</div>` : ''}
                            ${className === 'Job' ? `<h3>${item.title}</h3><div style="color:var(--secondary);font-weight:bold">${item.pay}</div><p style="font-size:0.8rem;margin-top:5px;">${item.desc}</p>` : ''}
                            <div style="font-size:0.8rem;color:#666;margin-top:8px;">ğŸ“ è”ç³»: ${item.contact}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        function switchSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
        }
        function goHome() { switchSection('market'); }
        function openModal(id) { if(!isLogin) return alert("è¯·å…ˆç‚¹å‡»'ç”¨æˆ·ç™»å½•'è¿æ¥äº‘ç«¯ï¼"); document.getElementById(id).classList.add('open'); }
        function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }
        function handleLogin() { isLogin = true; document.getElementById('loginBtn').style.display = 'none'; document.getElementById('userProfile').style.display = 'block'; alert("å·²æˆåŠŸè¿æ¥æ ¡å›­äº‘æ•°æ®åº“ï¼"); }

        window.onload = loadData;
    </script>
</body>
</html>
